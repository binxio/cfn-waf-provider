---
AWSTemplateFormatVersion: '2010-09-09'
Description: Demo stack for the rate-based rule provider

Resources:
  IpSetTestPredicate:
    Type: AWS::WAF::IPSet
    Properties:
      Name: ipset test predicate
      IPSetDescriptors:
      -
        Type: IPV4
        Value: 192.0.2.0/24
  SqlInjectionMatchSetTestPredicate:
    Type: AWS::WAF::SqlInjectionMatchSet
    Properties:
      Name: sql injection matchset test predicate
      SqlInjectionMatchTuples:
      -
        FieldToMatch:
          Type: URI
        TextTransformation: NONE
  RateBasedRuleWithPredicate:
    DependsOn:
    - IpSetTestPredicate
    - SqlInjectionMatchSetTestPredicate
    Type: Custom::RateBasedRule
    Properties:
      Name: WafRateBasedRulePredicate2
      MetricName: wafratebasedrulepredicatemetric
      RateKey: IP
      RateLimit: 3245
      MatchPredicates:
        -
          Negated: False
          Type: IPMatch
          DataId: !Ref IpSetTestPredicate
        -
          Negated: False
          Type: SqlInjectionMatch
          DataId: fakeidtocreaterror
      ServiceToken: !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:binxio-cfn-waf-provider'